(window.webpackJsonp=window.webpackJsonp||[]).push([[220],{hWRP:function(e,t,r){"use strict";r.r(t);var n,s=r("Kxc7"),a=r("txPx"),i=Object(a.getLogger)("Alerts.Price.RequestCache");function o(e,t){void 0===t&&(t=""),i.logDebug(e+" "+t)}!function(e){var t={};function r(e){var r=s(e);return t[r]&&o("got from cache",r),t[r]?t[r].self:null}function n(e,r){void 0===r&&(r=!1);var n=s(e),a=t[n];if(a)if(r)a.clearCacheTimeoutId&&clearTimeout(a.clearCacheTimeoutId),delete t[n],o("removed immediately",n);else{a.clearCacheTimeoutId=setTimeout((function(){delete t[n],o("removed timeout",n)}),5e3)}}function s(e){return JSON.stringify(e)}e.set=function(e,a){var i=s(e);r(e)&&n(e,!0),t[i]={self:a},o("added",i),a.then((function(t){return n(e),t})).catch((function(t){return n(e,!0),t}))},e.get=r,e.isCachable=function(e){return"list_alerts"===e.method||"list_events"===e.method}}(n||(n={}));var u,c=r("e3/o"),l=Object(a.getLogger)("Alerts.Price.MergedGetAlertsRequrest");function d(e,t){var r=t?JSON.stringify(t):"";l.logDebug(e+" "+r)}!function(e){var t={},r=null,n=null;function s(e){delete t[e],Object.keys(t).length||(n=null,r=null)}e.isMergable=function(e){return"get_alert"===e.method||"get_alerts"===e.method},e.mergeRequest=function(e){var a=Object(c.guid)(),i=new Promise((function(t,s){d("personal promise - creating",e),function(e){var t=[];"id"in e.params?t=[e.params.id]:"ids"in e.params&&(t=e.params.ids);n?n.params.ids=n.params.ids.concat(t):n={method:"get_alerts",params:{ids:t}}}(e),function(){r||(d("merged promise - creating"),(r=new Promise((function(e,t){setTimeout((function(){n?(d("send request to server - timeout"),q(n).then((function(t){e(t)})).catch(t)):t("No data to send request")}),500)}))).then((function(e){return d("merged promise - resolved")})),r.catch((function(e){return d("merged promise - rejected")})));return r}().then((function(r){var n=function(e,t){var r=t.alerts||[],n=null;if("get_alert"===e.method){var s=r.filter((function(t){return t.id===e.params.id}))[0];s&&(n={alert:s})}else if("get_alerts"===e.method){for(var a=e.params.ids,i=[],o=a.length-1;o>=0;o--)for(var u=a[o],c=r.length-1;c>=0;c--){var l=r[c];if(l.id===u){i.push(l);break}}i.length&&(n={alerts:i})}return n}(e,r);n?(d("personal promise - resolved",e),t(n)):(d("personal promise - rejected",e),s("not_exists"))})).catch(s)}));return i.then((function(e){return s(a),e})).catch((function(e){return s(a),e})),function(e,r){t[e]=r}(a,i),i}}(u||(u={}));var m,f=Object(a.getLogger)("Alerts.Price.MergedClearShownEventsRequest"),g=function(){function e(e){this._mergedRequest=null,this._mergedIds=new Set,this._delay=e}return e.prototype.mergeRequest=function(e){var t,r=this;if(e.params.alerts_ids.forEach((function(e){return r._mergedIds.add(e)})),!this._mergedRequest)var n=this._mergedRequest=(t=this._delay,new Promise((function(e){setTimeout(e,t)}))).then((function(){if(r._mergedRequest===n){var e=Array.from(r._mergedIds);f.logDebug("Sending merged request with ids "+e);var t=q({method:"clear_shown_events",params:{alerts_ids:e}});return t.then((function(){
f.logDebug("Merged request for ids "+e+" has succeeded"),r.cancel()}),(function(){f.logDebug("Merged request for ids "+e+" has failed"),r.cancel()})),t}throw"cancelled"}));return this._mergedRequest},e.prototype.cancel=function(){this._mergedRequest=null,this._mergedIds.clear()},e}();!function(e){var t=new g(1e3);e.isMergable=function(e){return"clear_shown_events"===e.method},e.mergeRequest=function(e){return t.mergeRequest(e)}}(m||(m={}));var h=r("xlbu"),p=r("BHQF");r.d(t,"sendRequest",(function(){return w})),r.d(t,"sendRequestImmediately",(function(){return q}));var _=Object(a.getLogger)("Alerts.Price.Request"),v=window.initData.price_alerts_url||"";s.enabled("alerts")&&!v&&_.logError("Url not passed");var b=new Set(["create_alert","stop_alert","stop_all","restart_alert","restart_all","delete_alert","delete_all","delete_events","update_extra","get_offline_events"]);function w(e){if(e.method&&b.has(e.method)){var t=Object.assign({},e.params);e.params&&"extra"in e.params&&(t.extra=JSON.parse(e.params.extra)),_.logNormal(JSON.stringify({m:e.method,p:t}))}if(u.isMergable(e))return u.mergeRequest(e);if(m.isMergable(e))return m.mergeRequest(e);if(n.isCachable(e)){var r=n.get(e);return r||(r=q(e),n.set(e,r)),r}return q(e)}function q(e){if(!v)return Promise.reject("no_alerts_url");if(!window.is_authenticated)return Promise.reject("not_authenticated");var t=e.method,r={body:JSON.stringify({m:t,p:e.params}),credentials:"include",method:"POST",headers:e.headers},n=(new Date).getTime(),s=v+"?log_username="+window.user.username;return Object(p.fetch)(s,r,{logBodyOnError:!0}).then((function(e){h.telemetry.sendReport("alerts","api_http_status",{value:e.status});var t=(new Date).getTime()-n;return h.telemetry.sendReport("alerts","api_time_frame",{value:t}),e.json()})).then((function(e){return"success"===e.m?e.p:"error"===e.m?Promise.reject(e.p.reason||"Unexpected server response"):Promise.reject("Unexpected server response")})).catch((function(e){return e instanceof Error?Promise.reject("Failed to fetch price-alerts: "+e):Promise.reject(e)}))}}}]);